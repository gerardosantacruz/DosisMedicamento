<!DOCTYPE html><html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Control de Fiebre y Medicaci√≥n Pedi√°trica</title>
<style>
:root{
  --bg:#f7f8fb;--card:#fff;--ink:#0f172a;--muted:#6b7280;--line:#e5e7eb;--pri:#2563eb;--ok:#16a34a;--warn:#f59e0b;--err:#dc2626;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
header{position:sticky;top:0;z-index:20;background:var(--pri);color:#fff;padding:12px 14px;display:flex;gap:10px;align-items:center;justify-content:space-between}
header .right{display:flex;gap:8px;align-items:center}
header select,header button{border:none;border-radius:10px;padding:8px 10px}
header select{background:#ffffff; color:#0f172a}
header button{background:#0f172a;color:#fff}
.container{max-width:960px;margin:0 auto;padding:14px;padding-bottom:88px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin:12px 0;box-shadow:0 2px 12px rgba(15,23,42,.06)}
label{display:block;margin-top:8px;font-size:.95rem}
input,select,textarea,button{width:100%;padding:12px;margin-top:6px;border-radius:10px;border:1px solid var(--line);font-size:1rem;background:#fff}
button{background:var(--pri);color:#fff;font-weight:700;border:none;cursor:pointer}
button.success{background:var(--ok)}
button.danger{background:var(--err)}
.row{display:grid;grid-template-columns:1fr;gap:10px}
@media(min-width:720px){.row{grid-template-columns:repeat(2,1fr)}}
.history-item{border:1px solid var(--line);border-radius:10px;padding:8px;margin:6px 0}
.chart-container{position:relative;height:220px}
.temp-normal{background:#dcfce7}
.temp-febr{background:#fef9c3}
.temp-fever{background:#fee2e2}
/* Tabs inferiores mejoradas */
.tabs{position:fixed;bottom:0;left:0;right:0;z-index:30;background:var(--card);border-top:1px solid var(--line);display:grid;grid-template-columns:repeat(5,1fr);gap:0;padding:6px env(safe-area-inset-right) calc(6px + env(safe-area-inset-bottom)) env(safe-area-inset-left)}
.tabbtn{appearance:none;background:transparent;border:none;padding:10px 4px;font-size:.85rem;color:var(--muted);display:flex;flex-direction:column;align-items:center;gap:4px}
.tabbtn.active{color:#fff;background:var(--pri);border-radius:12px}
.tabbtn span{font-size:.8rem}
.section{display:none}
.section.active{display:block}
.small{font-size:.85rem;color:var(--muted)}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border:1px solid var(--line);padding:8px;text-align:center}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:#f9fafb;font-size:.8rem}
</style>
</head>
<body>
<header>
  <div style="font-weight:800">Control Pedi√°trico</div>
  <div class="right">
    <select id="childSelect"></select>
    <button id="manageChildrenBtn">üë§</button>
  </div>
</header>
<div class="container">  <!-- CALCULADORA -->  <section id="calcSection" class="section active">
    <div class="card">
      <h3>Calculadora de dosis</h3>
      <div class="row">
        <div>
          <label for="weightInput">Peso (kg)</label>
          <input type="number" id="weightInput" step="0.1" inputmode="decimal" placeholder="Ej: 12.5" />
        </div>
        <div>
          <label for="medType">Medicamento</label>
          <select id="medType">
            <option value="Paracetamol">Paracetamol</option>
            <option value="Ibuprofeno">Ibuprofeno</option>
          </select>
        </div>
      </div>
      <label>Concentraci√≥n (tal como envase)</label>
      <div class="row">
        <div><label class="small">mg</label><input type="number" id="concMg" placeholder="Ej: 100" inputmode="numeric"/></div>
        <div><label class="small">ml</label><input type="number" id="concMl" placeholder="Ej: 5" inputmode="decimal"/></div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="calcDoseBtn">Calcular</button>
        <button id="saveDoseBtn" class="success">Registrar dosis</button>
      </div>
      <div id="doseResult" class="small" style="margin-top:8px"></div>
    </div>
  </section>  <!-- PLANIFICADOR con alternancia -->  <section id="planSection" class="section">
    <div class="card">
      <h3>Planificador de tomas</h3>
      <label for="planStart">Hora de inicio</label>
      <input type="time" id="planStart" /><label>Modo</label>
  <div class="row">
    <div>
      <input type="radio" name="planMode" id="modeSimple" value="simple" checked />
      <label for="modeSimple">Un solo medicamento</label>
      <div id="simpleBox">
        <label for="planLabel" class="small">Nombre</label>
        <input id="planLabel" type="text" placeholder="Ej: Ibuprofeno" />
        <label for="planInterval" class="small">Intervalo (horas)</label>
        <input id="planInterval" type="number" inputmode="numeric" value="6" />
      </div>
    </div>
    <div>
      <input type="radio" name="planMode" id="modeAlt" value="alt" />
      <label for="modeAlt">Alternar</label>
      <div id="altBox" style="display:none">
        <label for="altStart" class="small">Empieza con</label>
        <select id="altStart">
          <option>Ibuprofeno</option>
          <option>Paracetamol</option>
        </select>
        <label for="altStep" class="small">Separaci√≥n (horas)</label>
        <input id="altStep" type="number" inputmode="numeric" value="3" />
        <div class="small">Sugerencia: 3 h ‚Üí cada med queda cada 6 h.</div>
      </div>
    </div>
  </div>

  <label for="planDuration">Duraci√≥n (horas)</label>
  <input id="planDuration" type="number" inputmode="numeric" value="24" />

  <div class="row" style="margin-top:8px">
    <button id="genPlanBtn">Generar plan</button>
    <button id="genPlan48" class="badge">48 h</button>
  </div>
  <div id="planOutput" style="margin-top:8px"></div>
</div>

  </section>  <!-- TEMPERATURA -->  <section id="tempSection" class="section">
    <div class="card">
      <h3>Registro de temperatura</h3>
      <label for="tempValue">Temperatura (¬∞C)</label>
      <input id="tempValue" type="number" step="0.1" inputmode="decimal" />
      <label for="tempComment">Comentario</label>
      <textarea id="tempComment" rows="2"></textarea>
      <button id="saveTempBtn" class="success">Guardar</button>
    </div>
    <div class="card">
      <h4>Evoluci√≥n</h4>
      <div class="chart-container"><canvas id="tempChart"></canvas></div>
    </div>
    <div class="card" id="tempHistory"></div>
  </section>  <!-- HISTORIAL MEDICACI√ìN -->  <section id="medHistorySection" class="section">
    <div class="card" id="medHistory"></div>
  </section>  <!-- CONFIGURACI√ìN -->  <section id="configSection" class="section">
    <div class="card">
      <h3>Configuraci√≥n del hijo</h3>
      <label for="childName">Nombre</label>
      <input id="childName" type="text" />
      <label for="childWeight">Peso (kg)</label>
      <input id="childWeight" type="number" step="0.1" inputmode="decimal" />
      <div class="row" style="margin-top:8px">
        <button id="saveChildBtn" class="success">Guardar</button>
        <button id="deleteChildBtn" class="danger">Eliminar hijo</button>
      </div>
    </div>
  </section></div><!-- Tabs inferiores --><nav class="tabs">
  <button class="tabbtn active" data-section="calcSection">üìè<span>Calculadora</span></button>
  <button class="tabbtn" data-section="planSection">üóìÔ∏è<span>Plan</span></button>
  <button class="tabbtn" data-section="tempSection">üå°Ô∏è<span>Temp</span></button>
  <button class="tabbtn" data-section="medHistorySection">üíä<span>Hist.</span></button>
  <button class="tabbtn" data-section="configSection">‚öôÔ∏è<span>Config</span></button>
</nav><script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" integrity="sha256-qZ3QvE5h6Y4BvV8R4A0v2bfa6s1jpry8aYB2rS0A1wM=" crossorigin="anonymous"></script><script>
// --- Robust init with error banner and event delegation ---
(function(){
  'use strict';
  const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
  const pad=n=>String(n).padStart(2,'0');
  const safeNum=v=>{ const s=(v??'').toString().replace(',','.'); const n=parseFloat(s); return Number.isFinite(n)?n:NaN; };

  // Visible error surface
  window.onerror = function(msg, src, line, col, err){
    const div=document.createElement('div');
    div.style.cssText='position:fixed;left:0;right:0;top:0;z-index:9999;background:#fee2e2;color:#7f1d1d;padding:8px 12px;border-bottom:1px solid #fecaca;font-family:system-ui';
    div.textContent='Error: '+msg; document.body.appendChild(div);
  };

  // State
  let data = JSON.parse(localStorage.getItem('pediatricAppData')||'{}');
  if(!data.children) data.children={};
  let currentChildId=null; let tempChart=null;
  function save(){ localStorage.setItem('pediatricAppData', JSON.stringify(data)); }
  function genId(){ return 'id'+Date.now()+Math.random().toString(16).slice(2); }
  function fmtDT(ts){ return new Date(ts).toLocaleString(); }
  function tempClass(v){ if(v<37.5) return 'temp-normal'; if(v<38) return 'temp-febr'; return 'temp-fever'; }
  function tempColor(v){ if(v<37.5) return 'green'; if(v<38) return 'orange'; return 'red'; }

  // Ensure one child
  (function initChild(){
    const keys=Object.keys(data.children);
    if(keys.length===0){ const id=genId(); data.children[id]={name:'Ejemplo',weight:12.5,doses:[],temps:[]}; currentChildId=id; save(); }
    else { currentChildId=keys[0]; }
  })();

  const childSelect=$('#childSelect');
  function refreshChildSelect(){
    childSelect.innerHTML='';
    for(const id in data.children){ const o=document.createElement('option'); o.value=id; o.textContent=data.children[id].name; childSelect.appendChild(o); }
    childSelect.value=currentChildId;
  }
  function loadChildCfg(){ const c=data.children[currentChildId]; $('#childName').value=c.name||''; $('#childWeight').value=c.weight||''; }
  function refreshMedHistory(){ const box=$('#medHistory'); const list=data.children[currentChildId].doses; box.innerHTML='<h3>Historial de medicaci√≥n</h3>'+(list.map(d=>`<div class="history-item">${fmtDT(d.time)} ‚Äî ${d.info}</div>`).join('')||'<div class="small">Sin registros</div>'); }
  function refreshTempHistory(){ const box=$('#tempHistory'); const list=data.children[currentChildId].temps; box.innerHTML='<h3>Historial de temperatura</h3>'+(list.map(t=>`<div class="history-item ${tempClass(t.value)}">${fmtDT(t.time)} ‚Äî <b>${t.value.toFixed(1)}¬∞C</b> ${t.comment?('‚Äî '+t.comment):''}</div>`).join('')||'<div class="small">Sin registros</div>'); }
  function refreshAll(){ refreshMedHistory(); refreshTempHistory(); }

  function drawTempChart(){ try{ const el=$('#tempChart'); if(!el || typeof Chart==='undefined') return; const ctx=el.getContext('2d'); const arr=data.children[currentChildId].temps.slice().reverse(); const labels=arr.map(t=>new Date(t.time).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})); const vals=arr.map(t=>t.value); const colors=arr.map(t=>tempColor(t.value)); if(tempChart) tempChart.destroy(); tempChart=new Chart(ctx,{type:'line',data:{labels,datasets:[{label:'Temperatura ¬∞C',data:vals,borderColor:'#0f172a',backgroundColor:'rgba(15,23,42,.06)',pointBackgroundColor:colors,pointRadius:4,tension:.3}]},options:{responsive:true,scales:{y:{beginAtZero:false}}}});}catch(e){/* silent */} }

  function setDefaultStart(){ const now=new Date(); const m=now.getMinutes(); const r=Math.ceil(m/15)*15; now.setMinutes(r===60?0:r); if(r===60) now.setHours(now.getHours()+1); const val=`${pad(now.getHours())}:${pad(now.getMinutes())}`; const inp=$('#planStart'); if(inp) inp.value=val; }

  // Tab switching via delegation
  document.addEventListener('click',(ev)=>{
    const tab=ev.target.closest('.tabbtn');
    if(tab){ $$('.tabbtn').forEach(x=>x.classList.remove('active')); tab.classList.add('active'); $$('.section').forEach(s=>s.classList.remove('active')); const tgt=tab.dataset.section; if(tgt) $('#'+tgt).classList.add('active'); if(tgt==='tempSection') drawTempChart(); }

    const act=ev.target.closest('[data-action]');
    if(!act) return;
    const a=act.dataset.action;
    // Actions
    if(a==='calc'){
      const w = safeNum($('#weightInput').value || data.children[currentChildId].weight);
      const mg = safeNum($('#concMg').value); const ml = safeNum($('#concMl').value);
      const med = $('#medType').value;
      if(!Number.isFinite(w)||!Number.isFinite(mg)||!Number.isFinite(ml)||w<=0||mg<=0||ml<=0){ alert('Complete peso y concentraci√≥n (mg y ml).'); return; }
      const conc=mg/ml; let minMg,maxMg; if(med==='Paracetamol'){minMg=w*10;maxMg=w*15;} else {minMg=maxMg=w*10;}
      const minMl=minMg/conc, maxMl=maxMg/conc; $('#doseResult').textContent=`${Math.round(minMg)}‚Äì${Math.round(maxMg)} mg = ${minMl.toFixed(1)}‚Äì${maxMl.toFixed(1)} ml`;
    }
    if(a==='dose-save'){
      const txt=$('#doseResult').textContent; if(!txt){ alert('Primero calcule la dosis'); return; }
      data.children[currentChildId].doses.unshift({time:Date.now(),info:txt}); save(); refreshMedHistory();
    }
    if(a==='plan-gen' || a==='plan-48'){
      const hours = (a==='plan-48')?48: safeNum($('#planDuration').value)||24;
      const start=($('#planStart').value||'08:00').split(':'); let t=new Date(); t.setHours(parseInt(start[0]||'8',10), parseInt(start[1]||'0',10),0,0);
      const mode=document.querySelector('input[name="planMode"]:checked').value;
      const rows=[];
      if(mode==='simple'){
        const label=$('#planLabel').value||'Medicamento'; const step=parseInt($('#planInterval').value||'6',10);
        for(let p=0;p<=hours;p+=step){ rows.push([`${pad(t.getHours())}:${pad(t.getMinutes())}`,label]); t.setHours(t.getHours()+step); }
      } else {
        let next=$('#altStart').value; const step=parseInt($('#altStep').value||'3',10);
        for(let p=0;p<=hours;p+=step){ rows.push([`${pad(t.getHours())}:${pad(t.getMinutes())}`,next]); t.setHours(t.getHours()+step); next=(next==='Ibuprofeno')?'Paracetamol':'Ibuprofeno'; }
      }
      $('#planOutput').innerHTML='<table class="table"><thead><tr><th>Hora</th><th>Qu√© dar</th></tr></thead><tbody>'+rows.map(r=>`<tr><td>${r[0]}</td><td>${r[1]}</td></tr>`).join('')+'</tbody></table>';
    }
    if(a==='temp-save'){
      const v=safeNum($('#tempValue').value); if(!Number.isFinite(v)){ alert('Ingrese temperatura'); return; }
      const c=$('#tempComment').value; data.children[currentChildId].temps.unshift({time:Date.now(),value:v,comment:c}); save(); $('#tempValue').value=''; $('#tempComment').value=''; refreshTempHistory(); drawTempChart();
    }
    if(a==='child-save'){
      const c=data.children[currentChildId]; c.name=$('#childName').value; c.weight=safeNum($('#childWeight').value)||0; save(); refreshChildSelect(); alert('Datos guardados');
    }
    if(a==='child-del'){
      if(confirm('¬øEliminar este hijo?')){ delete data.children[currentChildId]; save(); const keys=Object.keys(data.children); if(keys.length===0){ const id=genId(); data.children[id]={name:'Ejemplo',weight:12,doses:[],temps:[]}; currentChildId=id; save(); } else { currentChildId=keys[0]; } refreshChildSelect(); loadChildCfg(); refreshAll(); drawTempChart(); }
    }
  });

  // Toggle mode boxes
  $('#modeSimple').addEventListener('change',()=>{ $('#simpleBox').style.display='block'; $('#altBox').style.display='none'; });
  $('#modeAlt').addEventListener('change',()=>{ $('#simpleBox').style.display='none'; $('#altBox').style.display='block'; });

  // Select change
  $('#childSelect').addEventListener('change',()=>{ currentChildId=$('#childSelect').value; loadChildCfg(); refreshAll(); drawTempChart(); });

  // Assign data-action attributes to buttons (in case cached HTML old)
  $('#calcDoseBtn')?.setAttribute('data-action','calc');
  $('#saveDoseBtn')?.setAttribute('data-action','dose-save');
  $('#genPlanBtn')?.setAttribute('data-action','plan-gen');
  $('#genPlan48')?.setAttribute('data-action','plan-48');
  $('#saveTempBtn')?.setAttribute('data-action','temp-save');
  $('#saveChildBtn')?.setAttribute('data-action','child-save');
  $('#deleteChildBtn')?.setAttribute('data-action','child-del');

  function refreshAll(){ refreshMedHistory(); refreshTempHistory(); }

  // Initial render
  refreshChildSelect(); loadChildCfg(); refreshAll(); setDefaultStart(); drawTempChart();
})();
</script></body>
</html>
